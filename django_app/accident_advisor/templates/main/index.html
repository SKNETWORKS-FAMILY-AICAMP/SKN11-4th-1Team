{% extends 'base.html' %}
{% load static %}

{% block title %}ë©”ì¸ ì±„íŒ… - ë…¸ëŠ{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        height: 80vh;
        display: flex;
    }
    
    .chat-sidebar {
        width: 300px;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
    }
    
    .chat-main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }
    
    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background-color: #ffffff;
    }
    
    .chat-input-area {
        padding: 20px;
        border-top: 1px solid #dee2e6;
        background-color: #f8f9fa;
    }
    
    .message {
        margin-bottom: 15px;
        display: flex;
    }
    
    .message.user {
        justify-content: flex-end;
    }
    
    .message.bot {
        justify-content: flex-start;
    }
    
    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        word-wrap: break-word;
        white-space: pre-wrap;
        line-height: 1.5;
    }
    
    /* íŒë¡€ ê²€ìƒ‰ ê²°ê³¼ ìŠ¤íƒ€ì¼ë§ */
    .message.bot .message-bubble {
        background-color: #f8f9fa;
        color: #333;
        margin-right: auto;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ ì§€ì› */
    .message-bubble h3,
    .message-bubble h4 {
        margin: 8px 0;
        color: #333;
    }
    
    .message-bubble h3 {
        font-size: 1.1em;
        font-weight: 600;
    }
    
    .message-bubble h4 {
        font-size: 1em;
        font-weight: 500;
    }
    
    .message-bubble strong {
        font-weight: 600;
    }
    
    .message-bubble ul {
        margin: 8px 0;
        padding-left: 20px;
    }
    
    .message-bubble li {
        margin: 4px 0;
    }
    
    /* ì´ëª¨ì§€ í¬ê¸° ì¡°ì • */
    .message-bubble .emoji {
        font-size: 1.1em;
    }
    
    .message.user .message-bubble {
        background-color: #007bff;
        color: white;
        margin-left: auto;
    }
    
    .message.bot .message-bubble {
        background-color: #f8f9fa;
        color: #333;
        margin-right: auto;
        border: 1px solid #e9ecef;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .session-item {
        padding: 12px 16px;
        border-bottom: 1px solid #dee2e6;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .session-item:hover {
        background-color: #e9ecef;
    }
    
    .session-item.active {
        background-color: #007bff;
        color: white;
    }
    
    .session-title {
        font-weight: 500;
        margin-bottom: 4px;
    }
    
    .session-time {
        font-size: 0.85em;
        opacity: 0.7;
    }
    
    @media (max-width: 768px) {
        .chat-sidebar {
            display: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="chat-container">
        <!-- ì‚¬ì´ë“œë°” - ì±„íŒ… íˆìŠ¤í† ë¦¬ -->
        <div class="chat-sidebar">
            <div class="p-3 border-bottom">
                <h5 class="mb-0">ì±„íŒ… ê¸°ë¡</h5>
                <button class="btn btn-primary btn-sm mt-2" id="newChatBtn">
                    <i class="bi bi-plus"></i> ìƒˆ ìƒë‹´ ì‹œì‘
                </button>
            </div>
            
            <div class="session-list">
                {% for session in recent_sessions %}
                <div class="session-item" data-session-id="{{ session.session_id }}">
                    <div class="session-title">{{ session.title }}</div>
                    <div class="session-time">
                        {{ session.updated_at|date:"mì›” dì¼ H:i" }}
                        ({{ session.message_count }}ê°œ ë©”ì‹œì§€)
                    </div>
                </div>
                {% empty %}
                <div class="p-3 text-muted text-center">
                    <i class="bi bi-chat"></i><br>
                    ì•„ì§ ìƒë‹´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- ë©”ì¸ ì±„íŒ… ì˜ì—­ -->
        <div class="chat-main">
            <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
            <div class="chat-messages" id="chatMessages">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-chat-dots fs-1"></i>
                    <h4 class="mt-3">êµí†µì‚¬ê³  ìƒë‹´ ì±—ë´‡ ë…¸ëŠ</h4>
                    <p>êµí†µì‚¬ê³  ìƒí™©ì„ ì•Œë ¤ì£¼ì‹œë©´ ê³¼ì‹¤ë¹„ìœ¨ì„ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</p>
                    
                    <div class="row mt-4">
                        <div class="col-md-6 mb-3">
                            <div class="card example-card" onclick="sendExampleMessage('êµì°¨ë¡œì—ì„œ ì¢ŒíšŒì „í•˜ë‹¤ê°€ ì§ì§„ì°¨ì™€ ì¶©ëŒí–ˆì–´ìš”')">
                                <div class="card-body text-start">
                                    <h6 class="card-title">ğŸš— êµì°¨ë¡œ ì‚¬ê³ </h6>
                                    <p class="card-text small">êµì°¨ë¡œì—ì„œ ì¢ŒíšŒì „í•˜ë‹¤ê°€ ì§ì§„ì°¨ì™€ ì¶©ëŒí–ˆì–´ìš”</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="card example-card" onclick="sendExampleMessage('ì£¼ì°¨ì¥ì—ì„œ í›„ì§„í•˜ë‹¤ê°€ ë‹¤ë¥¸ ì°¨ì™€ ì ‘ì´‰í–ˆì–´ìš”')">
                                <div class="card-body text-start">
                                    <h6 class="card-title">ğŸ…¿ï¸ ì£¼ì°¨ì¥ ì‚¬ê³ </h6>
                                    <p class="card-text small">ì£¼ì°¨ì¥ì—ì„œ í›„ì§„í•˜ë‹¤ê°€ ë‹¤ë¥¸ ì°¨ì™€ ì ‘ì´‰í–ˆì–´ìš”</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
            <div class="chat-input-area">
                <div class="input-group">
                    <textarea 
                        class="form-control" 
                        id="messageInput" 
                        placeholder="êµí†µì‚¬ê³  ìƒí™©ì„ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”..."
                        rows="2"></textarea>
                    <button class="btn btn-primary" id="sendBtn" type="button">
                        <i class="bi bi-send"></i> ì „ì†¡
                    </button>
                </div>
                <small class="text-muted">
                    <i class="bi bi-info-circle"></i> 
                    ë” ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ ì‚¬ê³  ìœ„ì¹˜, ì‹ í˜¸ë“± ìƒí™©, ê° ì°¨ëŸ‰ì˜ í–‰ë™ì„ êµ¬ì²´ì ìœ¼ë¡œ ì•Œë ¤ì£¼ì„¸ìš”.
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentSessionId = null;

// ë©”ì‹œì§€ ì „ì†¡
$('#sendBtn').click(sendMessage);
$('#messageInput').keypress(function(e) {
    if (e.which == 13 && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
    }
});

// ìƒˆ ì±„íŒ… ì‹œì‘
$('#newChatBtn').click(function() {
    currentSessionId = null;
    $('#chatMessages').html(`
        <div class="text-center text-muted py-5">
            <i class="bi bi-chat-dots fs-1"></i>
            <h4 class="mt-3">ìƒˆë¡œìš´ ìƒë‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤</h4>
            <p>êµí†µì‚¬ê³  ìƒí™©ì„ ì•Œë ¤ì£¼ì‹œë©´ ê³¼ì‹¤ë¹„ìœ¨ì„ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</p>
        </div>
    `);
    $('.session-item').removeClass('active');
});

// ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡
function sendExampleMessage(message) {
    $('#messageInput').val(message);
    sendMessage();
}

// ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
function sendMessage() {
    const message = $('#messageInput').val().trim();
    if (!message) return;
    
    // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    addMessage(message, 'user');
    $('#messageInput').val('');
    
    // ë´‡ ì‘ë‹µ ëŒ€ê¸° í‘œì‹œ
    addMessage('ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...', 'bot', true);
    
    // API í˜¸ì¶œ
    $.ajax({
        url: '{% url "main:send_message" %}',
        method: 'POST',
        data: JSON.stringify({
            message: message,
            session_id: currentSessionId
        }),
        contentType: 'application/json',
        success: function(response) {
            if (response.success) {
                // ëŒ€ê¸° ë©”ì‹œì§€ ì œê±°
                $('.message.bot:last').remove();
                
                // ë´‡ ì‘ë‹µ í‘œì‹œ
                addMessage(response.bot_response, 'bot');
                
                // ì„¸ì…˜ ID ì—…ë°ì´íŠ¸
                currentSessionId = response.session_id;
                
                // ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)
                updateSidebar(response.session_title);
            } else {
                $('.message.bot:last').remove();
                addMessage('ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bot');
            }
        },
        error: function() {
            $('.message.bot:last').remove();
            addMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'bot');
        }
    });
}

// ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜
function addMessage(content, sender, isLoading = false) {
    const messageClass = sender === 'user' ? 'user' : 'bot';
    const loadingClass = isLoading ? 'loading' : '';
    
    // ë´‡ ë©”ì‹œì§€ì˜ ê²½ìš° ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ ë³€í™˜
    if (sender === 'bot' && !isLoading) {
        content = formatBotMessage(content);
    }
    
    const messageHtml = `
        <div class="message ${messageClass} ${loadingClass}">
            <div class="message-bubble">
                ${isLoading ? '<i class="bi bi-three-dots"></i> ' + content : content}
            </div>
        </div>
    `;
    
    $('#chatMessages').append(messageHtml);
    $('#chatMessages').scrollTop($('#chatMessages')[0].scrollHeight);
}

// ë´‡ ë©”ì‹œì§€ í¬ë§·íŒ… í•¨ìˆ˜
function formatBotMessage(content) {
    // ê¸°ë³¸ ë§ˆí¬ë‹¤ìš´ ìŠ¤íƒ€ì¼ ë³€í™˜
    content = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // **êµµì€ê¸€ì”¨**
        .replace(/\*(.*?)\*/g, '<em>$1</em>') // *ê¸°ìš¸ì„*
        .replace(/^### (.*$)/gim, '<h4>$1</h4>') // ### ì œëª©
        .replace(/^## (.*$)/gim, '<h3>$1</h3>') // ## ì œëª©
        .replace(/^# (.*$)/gim, '<h2>$1</h2>') // # ì œëª©
        .replace(/^â€¢ (.*$)/gim, '<li>$1</li>') // â€¢ ë¶ˆë¦¿
        .replace(/^- (.*$)/gim, '<li>$1</li>'); // - ë¶ˆë¦¿
    
    // ë¦¬ìŠ¤íŠ¸ íƒœê·¸ë¡œ ê°ì‹¸ê¸°
    if (content.includes('<li>')) {
        content = content.replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
    }
    
    return content;
}

// ì‚¬ì´ë“œë°” ì—…ë°ì´íŠ¸
function updateSidebar(title) {
    // ìƒˆ ì„¸ì…˜ì´ë©´ ì‚¬ì´ë“œë°”ì— ì¶”ê°€
    // (ì‹¤ì œë¡œëŠ” í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ ë˜ëŠ” AJAXë¡œ ì—…ë°ì´íŠ¸)
}

// ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ
$('.session-item').click(function() {
    const sessionId = $(this).data('session-id');
    loadChatHistory(sessionId);
    
    $('.session-item').removeClass('active');
    $(this).addClass('active');
});

// ì±„íŒ… íˆìŠ¤í† ë¦¬ ë¡œë“œ í•¨ìˆ˜
function loadChatHistory(sessionId) {
    currentSessionId = sessionId;
    
    $.ajax({
        url: `/api/chat-history/${sessionId}/`,
        method: 'GET',
        success: function(response) {
            if (response.success) {
                $('#chatMessages').empty();
                
                response.messages.forEach(function(msg) {
                    addMessage(msg.content, msg.sender);
                });
            }
        },
        error: function() {
            alert('ì±„íŒ… ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
    });
}
</script>
{% endblock %}