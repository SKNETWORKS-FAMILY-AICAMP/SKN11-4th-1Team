{% extends 'base.html' %} {% load static %} {% block title %}메인 채팅 - 노느
{%endblock %} {% block extra_css %}
<style>
  .chat-container {
    height: calc(100vh - 40px);
    display: flex;
    flex-direction: column;
    background: var(--chat-bg);
    border-radius: 16px;
    box-shadow: 0 4px 20px var(--shadow-color);
    border: 1px solid var(--border-light);
    overflow: hidden;
    max-width: 1200px;
    margin: 0 auto;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    background: var(--chat-bg);
  }

  .chat-input-area {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-tertiary);
  }

  .message {
    margin-bottom: 16px;
    display: flex;
    animation: slideIn 0.3s ease-out;
    align-items: flex-end;
    gap: 12px;
  }

  .message.user {
    justify-content: flex-end;
  }

  .message.bot {
    justify-content: flex-start;
  }

  .message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(255, 107, 53, 0.15);
  }

  .message.user .message-avatar {
    order: 2;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
  }

  .message-bubble {
    max-width: 70%;
    padding: 14px 18px;
    border-radius: 18px;
    word-wrap: break-word;
    font-size: 15px;
    line-height: 1.5;
    box-shadow: 0 1px 2px var(--shadow-color);
    flex: 1;
  }

  .message.user .message-bubble {
    background: var(--message-user-bg);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }

  .message.bot .message-bubble {
    background: var(--message-bot-bg);
    color: var(--text-primary);
    margin-right: auto;
    border: 1px solid var(--border-light);
    border-bottom-left-radius: 4px;
  }

  /* 마크다운 렌더링 스타일 추가 */
  .message-bubble h1,
  .message-bubble h2,
  .message-bubble h3,
  .message-bubble h4,
  .message-bubble h5,
  .message-bubble h6 {
    margin: 16px 0 8px 0;
    color: var(--primary-color);
    font-weight: 600;
  }

  .message-bubble h1 {
    font-size: 1.4em;
  }
  .message-bubble h2 {
    font-size: 1.3em;
  }
  .message-bubble h3 {
    font-size: 1.2em;
  }
  .message-bubble h4 {
    font-size: 1.1em;
  }
  .message-bubble h5 {
    font-size: 1.05em;
  }
  .message-bubble h6 {
    font-size: 1em;
  }

  .message-bubble strong {
    font-weight: 600;
    color: var(--text-primary);
  }

  .message-bubble ul,
  .message-bubble ol {
    margin: 8px 0;
    padding-left: 20px;
  }

  .message-bubble li {
    margin: 4px 0;
    line-height: 1.4;
  }

  .message-bubble p {
    margin: 8px 0;
  }

  .message-bubble blockquote {
    border-left: 3px solid var(--primary-color);
    padding-left: 12px;
    margin: 12px 0;
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 8px 12px;
  }

  .message-bubble code {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: "Courier New", monospace;
    font-size: 0.9em;
  }

  .welcome-section {
    text-align: center;
    color: var(--text-secondary);
    padding: 40px 20px;
  }

  .welcome-section .bi {
    color: var(--primary-color);
    margin-bottom: 16px;
  }

  .welcome-section h4 {
    color: var(--text-primary);
    margin-bottom: 12px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .welcome-section p {
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .example-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid var(--border-light);
    background: var(--bg-secondary);
  }

  .example-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
  }

  .example-card .card-title {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 8px;
  }

  .example-card .card-text {
    color: var(--text-secondary);
    line-height: 1.4;
  }

  .input-group .form-control {
    border: 1px solid var(--border-color);
    border-radius: 12px 0 0 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    resize: none;
    font-size: 15px;
    padding: 14px 16px;
  }

  .input-group .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--input-focus);
    background: var(--input-bg);
    color: var(--text-primary);
  }

  .input-group .btn-primary {
    border-radius: 0 12px 12px 0;
    background: var(--primary-color);
    border-color: var(--primary-color);
    padding: 14px 20px;
    font-weight: 600;
  }

  .input-group .btn-primary:hover {
    background: var(--primary-hover);
    border-color: var(--primary-hover);
    transform: none;
  }

  .chat-info {
    margin-top: 8px;
    font-size: 13px;
    color: var(--text-muted);
  }

  .loading .message-bubble {
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes slideIn {
    from {
      transform: translateY(10px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.6;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <!-- 채팅 메시지 영역 -->
  <div class="chat-messages" id="chatMessages">
    <div class="welcome-section">
      <img
        src="{% static 'img/mainlogo.png' %}"
        alt="노느 로고"
        style="
          width: 120px;
          height: 120px;
          border-radius: 16px;
          margin-bottom: 20px;
          object-fit: contain;
          box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
          background: white;
          padding: 10px;
        "
      />
      <h4 class="mt-3">교통사고 상담 챗봇 노느</h4>
      <p>교통사고 상황을 알려주시면 과실비율을 분석해드립니다.</p>

      <div class="row mt-4">
        <!-- 1. 교통사고 상황 분석 (accident 카테고리) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('신호등이 있는 교차로에서 제가 좌회전하려는데 맞은편에서 직진해오던 차와 부딪혔어요. 제가 좌회전 신호를 확인하고 들어갔는데 상대방이 과속으로 와서 충돌했습니다.')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">🚗 사고 상황 분석</h6>
              <p class="card-text small">
                교차로 좌회전 중 직진차와 충돌 - 과실비율 분석
              </p>
            </div>
          </div>
        </div>
        
        <!-- 2. 판례 검색 (precedent 카테고리) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('대법원 2019다12345 판례를 찾아주세요')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">⚖️ 판례 검색</h6>
              <p class="card-text small">
                사건번호로 법원 판례 검색 및 상세 내용 확인
              </p>
            </div>
          </div>
        </div>
        
        <!-- 3. 도로교통법 조회 (law 카테고리) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('도로교통법 제25조에 대해 알려주세요')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">📚 법률 조회</h6>
              <p class="card-text small">
                도로교통법 조문 내용 및 적용 사례 안내
              </p>
            </div>
          </div>
        </div>
        
        <!-- 4. 용어 설명 (term 카테고리) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('과실비율이 무엇인가요?')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">📖 용어 설명</h6>
              <p class="card-text small">
                교통사고 관련 법률 용어의 정확한 의미 설명
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 메시지 입력 영역 -->
  <div class="chat-input-area">
    <div class="input-group">
      <textarea
        class="form-control"
        id="messageInput"
        placeholder="교통사고 상황을 자세히 설명해주세요..."
        rows="2"
      ></textarea>
      <button class="btn btn-primary" id="sendBtn" type="button">
        <i class="bi bi-send"></i> 전송
      </button>
    </div>
    <div class="chat-info">
      <i class="bi bi-info-circle"></i>
      더 정확한 분석을 위해 사고 위치, 신호등 상황, 각 차량의 행동을 구체적으로
      알려주세요.
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  let currentSessionId = null;

  // 마크다운 설정
  marked.setOptions({
    breaks: true,
    gfm: true,
    headerIds: false,
    mangle: false,
  });

  // 메시지 전송
  $("#sendBtn").click(sendMessage);
  $("#messageInput").keypress(function (e) {
    if (e.which == 13 && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // 예시 메시지 전송
  function sendExampleMessage(message) {
    $("#messageInput").val(message);
    sendMessage();
  }

  // 메시지 전송 함수
  function sendMessage() {
    const message = $("#messageInput").val().trim();
    if (!message) return;

    // 환영 화면 숨기기
    $(".welcome-section").hide();

    // 사용자 메시지 표시
    addMessage(message, "user");
    $("#messageInput").val("");

    // 봇 응답 대기 표시
    addMessage("분석 중입니다...", "bot", true);

    // API 호출
    $.ajax({
      url: '{% url "main:send_message" %}',
      method: "POST",
      data: JSON.stringify({
        message: message,
        session_id: currentSessionId,
      }),
      contentType: "application/json",
      success: function (response) {
        if (response.success) {
          // 대기 메시지 제거
          $(".message.bot:last").remove();

          // 봇 응답 표시 (마크다운 렌더링)
          addMessage(response.bot_response, "bot");

          // 세션 ID 업데이트
          currentSessionId = response.session_id;

          // 사이드바 채팅 기록 새로고침
          if (typeof loadChatHistory === "function") {
            loadChatHistory();
          }
        } else {
          $(".message.bot:last").remove();
          addMessage("죄송합니다. 오류가 발생했습니다.", "bot");
        }
      },
      error: function () {
        $(".message.bot:last").remove();
        addMessage("네트워크 오류가 발생했습니다.", "bot");
      },
    });
  }

  // 메시지 추가 함수 (마크다운 렌더링 적용)
  function addMessage(content, sender, isLoading = false) {
    const messageClass = sender === "user" ? "user" : "bot";
    const loadingClass = isLoading ? "loading" : "";

    let avatarHtml = "";
    if (sender === "bot") {
      avatarHtml =
        '<img src="{% static "img/chatbot.png" %}" alt="노느 챗봇" class="message-avatar">';
    } else {
      avatarHtml = '<div class="message-avatar">👤</div>';
    }

    // 마크다운 렌더링 (봇 메시지인 경우에만)
    let renderedContent;
    if (sender === "bot" && !isLoading) {
      try {
        renderedContent = marked.parse(content);
      } catch (e) {
        console.warn("마크다운 렌더링 실패:", e);
        renderedContent = content.replace(/\n/g, "<br>");
      }
    } else {
      renderedContent = isLoading
        ? '<i class="bi bi-three-dots"></i> ' + content
        : content.replace(/\n/g, "<br>");
    }

    const messageHtml = `
        <div class="message ${messageClass} ${loadingClass}">
            ${sender === "bot" ? avatarHtml : ""}
            <div class="message-bubble">
                ${renderedContent}
            </div>
            ${sender === "user" ? avatarHtml : ""}
        </div>
    `;

    $("#chatMessages").append(messageHtml);
    $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
  }

  // 페이지 로드 시 활성 네비게이션 설정
  $(document).ready(function () {
    // 현재 페이지에 따라 네비게이션 활성화
    const currentPath = window.location.pathname;
    $(".nav-link").removeClass("active");

    if (currentPath === "/" || currentPath.includes("/main/")) {
      $('a[href="{% url "main:index" %}"]').addClass("active");
    } else if (currentPath.includes("/community/")) {
      $('a[href="{% url "community:list" %}"]').addClass("active");
    }

    // URL에서 session 파라미터 확인
    const urlParams = new URLSearchParams(window.location.search);
    const sessionParam = urlParams.get("session");
    if (sessionParam) {
      loadSessionMessages(sessionParam);
    }

    // 새 채팅 버튼 기능
    $(".new-chat").click(function (e) {
      e.preventDefault();
      startNewChat();
    });
  });

  // 새 채팅 시작 함수
  function startNewChat() {
    currentSessionId = null;
    $("#chatMessages").html(`
      <div class="welcome-section">
        <img
          src="{% static 'img/mainlogo.png' %}"
          alt="노느 로고"
          style="
            width: 120px;
            height: 120px;
            border-radius: 16px;
            margin-bottom: 20px;
            object-fit: contain;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
            background: white;
            padding: 10px;
          "
        />
        <h4 class="mt-3">교통사고 상담 챗봇 노느</h4>
        <p>교통사고 상황을 알려주시면 과실비율을 분석해드립니다.</p>
        
        <div class="row mt-4">
          <!-- 1. 교통사고 상황 분석 (accident 카테고리) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('신호등이 있는 교차로에서 제가 좌회전하려는데 맞은편에서 직진해오던 차와 부딪혔어요. 제가 좌회전 신호를 확인하고 들어갔는데 상대방이 과속으로 와서 충돌했습니다.')">
              <div class="card-body text-start">
                <h6 class="card-title">🚗 사고 상황 분석</h6>
                <p class="card-text small">교차로 좌회전 중 직진차와 충돌 - 과실비율 분석</p>
              </div>
            </div>
          </div>
          
          <!-- 2. 판례 검색 (precedent 카테고리) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('대법원 2019다12345 판례를 찾아주세요')">
              <div class="card-body text-start">
                <h6 class="card-title">⚖️ 판례 검색</h6>
                <p class="card-text small">사건번호로 법원 판례 검색 및 상세 내용 확인</p>
              </div>
            </div>
          </div>
          
          <!-- 3. 도로교통법 조회 (law 카테고리) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('도로교통법 제25조에 대해 알려주세요')">
              <div class="card-body text-start">
                <h6 class="card-title">📚 법률 조회</h6>
                <p class="card-text small">도로교통법 조문 내용 및 적용 사례 안내</p>
              </div>
            </div>
          </div>
          
          <!-- 4. 용어 설명 (term 카테고리) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('과실비율이 무엇인가요?')">
              <div class="card-body text-start">
                <h6 class="card-title">📖 용어 설명</h6>
                <p class="card-text small">교통사고 관련 법률 용어의 정확한 의미 설명</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    `);

    // 활성 세션 제거
    $(".session-item").removeClass("active");

    // URL에서 session 파라미터 제거
    if (window.history.replaceState) {
      window.history.replaceState(null, null, window.location.pathname);
    }
  }

  // 세션 메시지 로드 함수 (마크다운 렌더링 적용)
  function loadSessionMessages(sessionId) {
    $.ajax({
      url: `{% url "main:chat_history" "dummy" %}`.replace("dummy", sessionId),
      method: "GET",
      success: function (response) {
        if (response.success) {
          currentSessionId = sessionId;
          $("#chatMessages").html("");

          response.messages.forEach(function (msg) {
            addMessage(msg.content, msg.sender);
          });

          // 활성 세션 표시
          $(".session-item").removeClass("active");
          $(`.session-item[data-session-id="${sessionId}"]`).addClass("active");
        }
      },
      error: function () {
        alert("채팅 기록을 불러오는데 실패했습니다.");
      },
    });
  }

  // 전역 함수로 등록 (base.html에서 호출할 수 있도록)
  window.loadSessionMessages = loadSessionMessages;
</script>
{% endblock %}
