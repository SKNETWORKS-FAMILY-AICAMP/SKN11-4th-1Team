{% extends 'base.html' %} {% load static %} {% block title %}메인 채팅 - 노느
{%endblock %} {% block extra_css %}
<style>
  .chat-container {
    height: calc(100vh - 40px);
    display: flex;
    flex-direction: column;
    background: var(--chat-bg);
    border-radius: 16px;
    box-shadow: 0 4px 20px var(--shadow-color);
    border: 1px solid var(--border-light);
    overflow: hidden;
    max-width: 1200px;
    margin: 0 auto;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    background: var(--chat-bg);
  }

  .chat-input-area {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-tertiary);
  }

  .message {
    margin-bottom: 16px;
    display: flex;
    animation: slideIn 0.3s ease-out;
    align-items: flex-end;
    gap: 12px;
  }

  .message.user {
    justify-content: flex-end;
  }

  .message.bot {
    justify-content: flex-start;
  }

  .message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(255, 107, 53, 0.15);
  }

  .message.user .message-avatar {
    order: 2;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
  }

  .message-bubble {
    max-width: 70%;
    padding: 14px 18px;
    border-radius: 18px;
    word-wrap: break-word;
    font-size: 15px;
    line-height: 1.5;
    box-shadow: 0 1px 2px var(--shadow-color);
    flex: 1;
  }

  .message.user .message-bubble {
    background: var(--message-user-bg);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }

  .message.bot .message-bubble {
    background: var(--message-bot-bg);
    color: var(--text-primary);
    margin-right: auto;
    border: 1px solid var(--border-light);
    border-bottom-left-radius: 4px;
  }

  /* 마크다운 렌더링 스타일 추가 */
  .message-bubble h1,
  .message-bubble h2,
  .message-bubble h3,
  .message-bubble h4,
  .message-bubble h5,
  .message-bubble h6 {
    margin: 16px 0 8px 0;
    color: var(--primary-color);
    font-weight: 600;
  }

  .message-bubble h1 {
    font-size: 1.4em;
  }
  .message-bubble h2 {
    font-size: 1.3em;
  }
  .message-bubble h3 {
    font-size: 1.2em;
  }
  .message-bubble h4 {
    font-size: 1.1em;
  }
  .message-bubble h5 {
    font-size: 1.05em;
  }
  .message-bubble h6 {
    font-size: 1em;
  }

  .message-bubble strong {
    font-weight: 600;
    color: var(--text-primary);
  }

  .message-bubble ul,
  .message-bubble ol {
    margin: 8px 0;
    padding-left: 20px;
  }

  .message-bubble li {
    margin: 4px 0;
    line-height: 1.4;
  }

  .message-bubble p {
    margin: 8px 0;
  }

  .message-bubble blockquote {
    border-left: 3px solid var(--primary-color);
    padding-left: 12px;
    margin: 12px 0;
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 8px 12px;
  }

  .message-bubble code {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: "Courier New", monospace;
    font-size: 0.9em;
  }

  .welcome-section {
    text-align: center;
    color: var(--text-secondary);
    padding: 40px 20px;
  }

  .welcome-section .bi {
    color: var(--primary-color);
    margin-bottom: 16px;
  }

  .welcome-section h4 {
    color: var(--text-primary);
    margin-bottom: 12px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .welcome-section p {
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .example-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid var(--border-light);
    background: var(--bg-secondary);
  }

  .example-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
  }

  .example-card .card-title {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 8px;
  }

  .example-card .card-text {
    color: var(--text-secondary);
    line-height: 1.4;
  }

  .input-group .form-control {
    border: 1px solid var(--border-color);
    border-radius: 12px 0 0 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    resize: none;
    font-size: 15px;
    padding: 14px 16px;
  }

  .input-group .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--input-focus);
    background: var(--input-bg);
    color: var(--text-primary);
  }

  .input-group .btn-primary {
    border-radius: 0 12px 12px 0;
    background: var(--primary-color);
    border-color: var(--primary-color);
    padding: 14px 20px;
    font-weight: 600;
  }

  .input-group .btn-primary:hover {
    background: var(--primary-hover);
    border-color: var(--primary-hover);
    transform: none;
  }

  .chat-info {
    margin-top: 8px;
    font-size: 13px;
    color: var(--text-muted);
  }

  .loading .message-bubble {
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes slideIn {
    from {
      transform: translateY(10px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.6;
    }
  }

  /* ✅ 메모리 인사이트 스타일 */
  .memory-insights {
    animation: slideInUp 0.3s ease-out;
  }

  .memory-item {
    padding: 6px 0;
    font-size: 14px;
    color: var(--text-primary);
    border-left: 3px solid var(--primary-color);
    padding-left: 12px;
    margin: 4px 0;
    background: rgba(255, 107, 53, 0.05);
    border-radius: 0 8px 8px 0;
  }

  /* ✅ 추천 패널 스타일 */
  .recommendations-panel {
    animation: slideInUp 0.3s ease-out;
  }

  .recommendation-item {
    padding: 10px 14px;
    background: white;
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .recommendation-item:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
  }

  .recommendation-item:last-child {
    margin-bottom: 0;
  }

  @keyframes slideInUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <!-- 채팅 메시지 영역 -->
  <div class="chat-messages" id="chatMessages">
    <div class="welcome-section">
      <img
        src="{% static 'img/mainlogo.png' %}"
        alt="노느 로고"
        style="
          width: 120px;
          height: 120px;
          border-radius: 16px;
          margin-bottom: 20px;
          object-fit: contain;
          box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
          background: white;
          padding: 10px;
        "
      />
      <h4 class="mt-3">교통사고 상담 챗봇 노느</h4>
      <p>교통사고 상황을 알려주시면 과실비율을 분석해드립니다.</p>

      <div class="row mt-4">
        <!-- 1. 교통사고 상황 분석 (accident 카테고리) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('교차로에서 녹색신호로 직진하는데 빨간불 무시하고 직진하는 차와 충돌했어')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">🚗 사고 상황 분석</h6>
              <p class="card-text small">
                교차로 직진 중 빨간불 무시하고 직진하는 차와 충돌 - 과실비율 분석
              </p>
            </div>
          </div>
        </div>
        
        <!-- 2. 판례 검색 (precedent 카테고리) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('대법원 92도2077 판례를 찾아주세요')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">⚖️ 판례 검색</h6>
              <p class="card-text small">
                대법원 92도2077 판례를 찾아주세요
              </p>
            </div>
          </div>
        </div>
        
        <!-- 3. 도로교통법 조회 (law 카테고리) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('도로교통법 제11조에 대해 알려주세요')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">📚 법률 조회</h6>
              <p class="card-text small">
                도로교통법 제11조에 대해 알려주세요
              </p>
            </div>
          </div>
        </div>
        
        <!-- 4. 용어 설명 (term 카테고리) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('과실비율이 무엇인가요?')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">📖 용어 설명</h6>
              <p class="card-text small">
                교통사고 관련 법률 용어의 정확한 의미 설명
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 메모리 인사이트 표시 영역 -->
  <div class="memory-insights" id="memoryInsights" style="display: none;">
    <div class="alert alert-info border-0 bg-gradient" style="background: linear-gradient(45deg, rgba(255, 107, 53, 0.1), rgba(54, 162, 235, 0.1)); border-radius: 12px; margin: 16px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <div class="d-flex align-items-center">
        <i class="bi bi-brain text-primary me-2" style="font-size: 1.2em;"></i>
        <strong>💡 AI 메모리 인사이트</strong>
      </div>
      <div id="memoryContent" class="mt-2"></div>
    </div>
  </div>

  <!-- 실시간 추천 패널 (비활성화) -->
  <!-- 
  <div class="recommendations-panel" id="recommendationsPanel" style="display: none; margin: 16px 24px;">
    <div class="card border-0 shadow-sm" style="border-radius: 12px; background: linear-gradient(45deg, rgba(255, 193, 7, 0.05), rgba(40, 167, 69, 0.05));">
      <div class="card-body">
        <h6 class="card-title text-warning d-flex align-items-center">
          <i class="bi bi-lightbulb-fill me-2"></i> 맞춤 추천
        </h6>
        <div id="recommendationsList"></div>
      </div>
    </div>
  </div>
  -->

  <!-- 메시지 입력 영역 -->
  <div class="chat-input-area">
    <div class="input-group">
      <textarea
        class="form-control"
        id="messageInput"
        placeholder="교통사고 상황을 자세히 설명해주세요..."
        rows="2"
      ></textarea>
      <button class="btn btn-primary" id="sendBtn" type="button">
        <i class="bi bi-send"></i> 전송
      </button>
    </div>
    <div class="chat-info">
      <i class="bi bi-info-circle"></i>
      더 정확한 분석을 위해 사고 위치, 신호등 상황, 각 차량의 행동을 구체적으로
      알려주세요.
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  let currentSessionId = null;

  // 마크다운 설정
  marked.setOptions({
    breaks: true,
    gfm: true,
    headerIds: false,
    mangle: false,
  });

  // 메시지 전송
  $("#sendBtn").click(sendMessage);
  $("#messageInput").keypress(function (e) {
    if (e.which == 13 && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // 예시 메시지 전송
  function sendExampleMessage(message) {
    $("#messageInput").val(message);
    sendMessage();
  }

  // 메시지 전송 함수
  function sendMessage() {
    const message = $("#messageInput").val().trim();
    if (!message) return;

    // 환영 화면 숨기기
    $(".welcome-section").hide();

    // 사용자 메시지 표시
    addMessage(message, "user");
    $("#messageInput").val("");

    // 봇 응답 대기 표시
    addMessage("분석 중입니다...", "bot", true);

    // API 호출
    $.ajax({
      url: '{% url "main:send_message" %}',
      method: "POST",
      data: JSON.stringify({
        message: message,
        session_id: currentSessionId,
      }),
      contentType: "application/json",
      timeout: 60000,  // 타임아웃 60초로 증가
      success: function (response) {
      if (response.success) {
      // 대기 메시지 제거
      $(".message.bot:last").remove();

      // 봇 응답 표시 (마크다운 렌더링)
      addMessage(response.bot_response, "bot");

      // 세션 ID 업데이트
      currentSessionId = response.session_id;

      // ✅ 메모리 인사이트 표시
      if (response.memory_insights) {
        displayMemoryInsights(response.memory_insights);
      }

      // ✅ 실시간 추천 로드 (비활성화)
      // if (currentSessionId) {
      //   loadLiveRecommendations(currentSessionId);
      // }

          // 사이드바 채팅 기록 새로고침
            if (typeof loadChatHistory === "function") {
              loadChatHistory();
            }
          } else {
            $(".message.bot:last").remove();
            addMessage("죄송합니다. 오류가 발생했습니다.", "bot");
          }
        },
      error: function (xhr, status, error) {
        $(".message.bot:last").remove();
        
        if (status === 'timeout') {
          addMessage("타임아웃이 발생했습니다. 잠시만 기다려주세요... 현재 처리 중인 요청이 많아 응답이 지연될 수 있습니다.", "bot");
        } else if (xhr.status === 500) {
          addMessage("서버 오류가 발생했습니다. AI 응답 생성 중 문제가 발생했습니다.", "bot");
        } else {
          addMessage("네트워크 오류가 발생했습니다. 다시 시도해주세요.", "bot");
        }
      },
    });
  }

  // 메시지 추가 함수 (마크다운 렌더링 적용)
  function addMessage(content, sender, isLoading = false) {
    const messageClass = sender === "user" ? "user" : "bot";
    const loadingClass = isLoading ? "loading" : "";

    let avatarHtml = "";
    if (sender === "bot") {
      avatarHtml =
        '<img src="{% static "img/chatbot.png" %}" alt="노느 챗봇" class="message-avatar">';
    } else {
      avatarHtml = '<div class="message-avatar">👤</div>';
    }

    // 마크다운 렌더링 (봇 메시지인 경우에만)
    let renderedContent;
    if (sender === "bot" && !isLoading) {
      try {
        renderedContent = marked.parse(content);
      } catch (e) {
        console.warn("마크다운 렌더링 실패:", e);
        renderedContent = content.replace(/\n/g, "<br>");
      }
    } else {
      renderedContent = isLoading
        ? '<i class="bi bi-three-dots"></i> ' + content
        : content.replace(/\n/g, "<br>");
    }

    const messageHtml = `
        <div class="message ${messageClass} ${loadingClass}">
            ${sender === "bot" ? avatarHtml : ""}
            <div class="message-bubble">
                ${renderedContent}
            </div>
            ${sender === "user" ? avatarHtml : ""}
        </div>
    `;

    $("#chatMessages").append(messageHtml);
    $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
  }

  // 페이지 로드 시 활성 네비게이션 설정
  $(document).ready(function () {
    // 현재 페이지에 따라 네비게이션 활성화
    const currentPath = window.location.pathname;
    $(".nav-link").removeClass("active");

    if (currentPath === "/" || currentPath.includes("/main/")) {
      $('a[href="{% url "main:index" %}"]').addClass("active");
    } else if (currentPath.includes("/community/")) {
      $('a[href="{% url "community:list" %}"]').addClass("active");
    }

    // URL에서 session 파라미터 확인
    const urlParams = new URLSearchParams(window.location.search);
    const sessionParam = urlParams.get("session");
    if (sessionParam) {
      loadSessionMessages(sessionParam);
    }

    // 새 채팅 버튼 기능
    $(".new-chat").click(function (e) {
      e.preventDefault();
      startNewChat();
    });
  });

  // 새 채팅 시작 함수
  function startNewChat() {
    currentSessionId = null;
    $("#chatMessages").html(`
      <div class="welcome-section">
        <img
          src="{% static 'img/mainlogo.png' %}"
          alt="노느 로고"
          style="
            width: 120px;
            height: 120px;
            border-radius: 16px;
            margin-bottom: 20px;
            object-fit: contain;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
            background: white;
            padding: 10px;
          "
        />
        <h4 class="mt-3">교통사고 상담 챗봇 노느</h4>
        <p>교통사고 상황을 알려주시면 과실비율을 분석해드립니다.</p>
        
        <div class="row mt-4">
          <!-- 1. 교통사고 상황 분석 (accident 카테고리) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('교차로에서 녹색신호로 직진하는데 빨간불 무시하고 직진하는 차와 충돌했어')">
              <div class="card-body text-start">
                <h6 class="card-title">🚗 사고 상황 분석</h6>
                <p class="card-text small">교차로 직진 중 빨간불 무시하고 직진하는 차와 충돌 - 과실비율 분석</p>
              </div>
            </div>
          </div>
          
          <!-- 2. 판례 검색 (precedent 카테고리) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('대법원 92도2077 판례를 찾아주세요')">
              <div class="card-body text-start">
                <h6 class="card-title">⚖️ 판례 검색</h6>
                <p class="card-text small">대법원 92도2077 판례를 찾아주세요</p>
              </div>
            </div>
          </div>
          
          <!-- 3. 도로교통법 조회 (law 카테고리) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('도로교통법 제11조에 대해 알려주세요')">
              <div class="card-body text-start">
                <h6 class="card-title">📚 법률 조회</h6>
                <p class="card-text small">도로교통법 제11조에 대해 알려주세요</p>
              </div>
            </div>
          </div>
          
          <!-- 4. 용어 설명 (term 카테고리) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('과실비율이 무엇인가요?')">
              <div class="card-body text-start">
                <h6 class="card-title">📖 용어 설명</h6>
                <p class="card-text small">교통사고 관련 법률 용어의 정확한 의미 설명</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    `);

    // 활성 세션 제거
    $(".session-item").removeClass("active");

    // URL에서 session 파라미터 제거
    if (window.history.replaceState) {
      window.history.replaceState(null, null, window.location.pathname);
    }
  }

  // 세션 메시지 로드 함수 (마크다운 렌더링 적용)
  function loadSessionMessages(sessionId) {
    $.ajax({
      url: `{% url "main:chat_history" "dummy" %}`.replace("dummy", sessionId),
      method: "GET",
      success: function (response) {
        if (response.success) {
          currentSessionId = sessionId;
          $("#chatMessages").html("");

          response.messages.forEach(function (msg) {
            addMessage(msg.content, msg.sender);
          });

          // 활성 세션 표시
          $(".session-item").removeClass("active");
          $(`.session-item[data-session-id="${sessionId}"]`).addClass("active");
        }
      },
      error: function () {
        alert("채팅 기록을 불러오는데 실패했습니다.");
      },
    });
  }

  // ✅ 메모리 인사이트 표시 함수
  function displayMemoryInsights(insights) {
    const memoryDiv = $("#memoryInsights");
    const contentDiv = $("#memoryContent");
    
    let content = '';
    
    try {
      // 연관 질문 정보
      const context = insights.conversation_context || {};
      const followup = context.followup_info || {};
      
      if (followup.has_followup && followup.confidence > 0.6) {
        const confidence = Math.round(followup.confidence * 100);
        content += `<div class="memory-item">🔗 이전 대화와 연관된 질문으로 이해했습니다 (정확도: ${confidence}%)</div>`;
      }
      
      // 사용자 레벨 정보
      const userLevel = insights.user_level || {};
      if (userLevel.explanation_level) {
        const levelNames = {
          'beginner': '초보자',
          'intermediate': '중급자', 
          'advanced': '전문가'
        };
        const levelName = levelNames[userLevel.explanation_level] || '일반';
        const interactionCount = userLevel.interaction_count || 0;
        content += `<div class="memory-item">👤 현재 레벨: ${levelName} (상호작용 ${interactionCount}회)</div>`;
      }
      
      // 학습 진행도
      const learning = insights.learning_progress || {};
      if (Object.keys(learning).length > 0) {
        const avgProgress = Math.round(Object.values(learning).reduce((a, b) => a + b, 0) / Object.keys(learning).length * 100);
        content += `<div class="memory-item">📚 전체 학습 진행도: ${avgProgress}%</div>`;
      }
      
      // 숙련 분야
      const usage = insights.usage_analytics || {};
      if (usage.category_usage && Object.keys(usage.category_usage).length > 0) {
        const topCategories = Object.entries(usage.category_usage)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 2)
          .map(([cat, count]) => {
            const categoryNames = {
              'accident': '사고분석',
              'precedent': '판례검색',
              'law': '법률조회',
              'term': '용어설명'
            };
            return categoryNames[cat] || cat;
          });
        
        if (topCategories.length > 0) {
          content += `<div class="memory-item">⭐ 주요 활용 분야: ${topCategories.join(', ')}</div>`;
        }
      }
      
      if (content) {
        contentDiv.html(content);
        memoryDiv.fadeIn(300);
        
        // 6초 후 자동 숨김
        setTimeout(() => {
          memoryDiv.fadeOut(300);
        }, 6000);
      }
    } catch (error) {
      console.warn('메모리 인사이트 표시 오류:', error);
    }
  }

  // ✅ 실시간 추천 로드 함수
  function loadLiveRecommendations(sessionId) {
    if (!sessionId) return;
    
    $.ajax({
      url: `{% url "main:live_recommendations" "dummy" %}`.replace("dummy", sessionId),
      method: "GET",
      success: function(response) {
        if (response.success && response.recommendations && response.recommendations.length > 0) {
          displayRecommendations(response.recommendations);
        }
      },
      error: function(xhr, status, error) {
        console.log('추천 로드 실패:', error);
      }
    });
  }

  // ✅ 추천 표시 함수
  function displayRecommendations(recommendations) {
    const panelDiv = $("#recommendationsPanel");
    const listDiv = $("#recommendationsList");
    
    if (recommendations && recommendations.length > 0) {
      const items = recommendations.map(rec => {
        const escapedRec = rec.replace(/'/g, "\\'")
                            .replace(/"/g, '&quot;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
        return `<div class="recommendation-item" onclick="sendExampleMessage('${escapedRec}')">
                  <i class="bi bi-lightbulb text-warning"></i>
                  ${rec}
                </div>`;
      }).join('');
      
      listDiv.html(items);
      panelDiv.slideDown(300);
      
      // 12초 후 자동 숨김
      setTimeout(() => {
        panelDiv.slideUp(300);
      }, 12000);
    }
  }

  // 전역 함수로 등록 (base.html에서 호출할 수 있도록)
  window.loadSessionMessages = loadSessionMessages;
  window.displayMemoryInsights = displayMemoryInsights;
  window.loadLiveRecommendations = loadLiveRecommendations;
</script>
{% endblock %}
