{% extends 'base.html' %} {% load static %} {% block title %}ë©”ì¸ ì±„íŒ… - ë…¸ëŠ
{%endblock %} {% block extra_css %}
<style>
  .chat-container {
    height: calc(100vh - 40px);
    display: flex;
    flex-direction: column;
    background: var(--chat-bg);
    border-radius: 16px;
    box-shadow: 0 4px 20px var(--shadow-color);
    border: 1px solid var(--border-light);
    overflow: hidden;
    max-width: 1200px;
    margin: 0 auto;
  }

  .chat-messages {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
    background: var(--chat-bg);
  }

  .chat-input-area {
    padding: 20px;
    border-top: 1px solid var(--border-color);
    background: var(--bg-tertiary);
  }

  .message {
    margin-bottom: 16px;
    display: flex;
    animation: slideIn 0.3s ease-out;
    align-items: flex-end;
    gap: 12px;
  }

  .message.user {
    justify-content: flex-end;
  }

  .message.bot {
    justify-content: flex-start;
  }

  .message-avatar {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    flex-shrink: 0;
    object-fit: cover;
    box-shadow: 0 2px 6px rgba(255, 107, 53, 0.15);
  }

  .message.user .message-avatar {
    order: 2;
    background: var(--primary-color);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 14px;
  }

  .message-bubble {
    max-width: 70%;
    padding: 14px 18px;
    border-radius: 18px;
    word-wrap: break-word;
    font-size: 15px;
    line-height: 1.5;
    box-shadow: 0 1px 2px var(--shadow-color);
    flex: 1;
  }

  .message.user .message-bubble {
    background: var(--message-user-bg);
    color: white;
    margin-left: auto;
    border-bottom-right-radius: 4px;
  }

  .message.bot .message-bubble {
    background: var(--message-bot-bg);
    color: var(--text-primary);
    margin-right: auto;
    border: 1px solid var(--border-light);
    border-bottom-left-radius: 4px;
  }

  /* ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
  .message-bubble h1,
  .message-bubble h2,
  .message-bubble h3,
  .message-bubble h4,
  .message-bubble h5,
  .message-bubble h6 {
    margin: 16px 0 8px 0;
    color: var(--primary-color);
    font-weight: 600;
  }

  .message-bubble h1 {
    font-size: 1.4em;
  }
  .message-bubble h2 {
    font-size: 1.3em;
  }
  .message-bubble h3 {
    font-size: 1.2em;
  }
  .message-bubble h4 {
    font-size: 1.1em;
  }
  .message-bubble h5 {
    font-size: 1.05em;
  }
  .message-bubble h6 {
    font-size: 1em;
  }

  .message-bubble strong {
    font-weight: 600;
    color: var(--text-primary);
  }

  .message-bubble ul,
  .message-bubble ol {
    margin: 8px 0;
    padding-left: 20px;
  }

  .message-bubble li {
    margin: 4px 0;
    line-height: 1.4;
  }

  .message-bubble p {
    margin: 8px 0;
  }

  .message-bubble blockquote {
    border-left: 3px solid var(--primary-color);
    padding-left: 12px;
    margin: 12px 0;
    background: var(--bg-tertiary);
    border-radius: 4px;
    padding: 8px 12px;
  }

  .message-bubble code {
    background: var(--bg-tertiary);
    padding: 2px 6px;
    border-radius: 4px;
    font-family: "Courier New", monospace;
    font-size: 0.9em;
  }

  .welcome-section {
    text-align: center;
    color: var(--text-secondary);
    padding: 40px 20px;
  }

  .welcome-section .bi {
    color: var(--primary-color);
    margin-bottom: 16px;
  }

  .welcome-section h4 {
    color: var(--text-primary);
    margin-bottom: 12px;
    font-weight: 700;
    letter-spacing: -0.02em;
  }

  .welcome-section p {
    color: var(--text-secondary);
    margin-bottom: 24px;
    line-height: 1.6;
  }

  .example-card {
    cursor: pointer;
    transition: all 0.2s ease;
    border: 1px solid var(--border-light);
    background: var(--bg-secondary);
  }

  .example-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-color);
    box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
  }

  .example-card .card-title {
    color: var(--primary-color);
    font-weight: 600;
    margin-bottom: 8px;
  }

  .example-card .card-text {
    color: var(--text-secondary);
    line-height: 1.4;
  }

  .input-group .form-control {
    border: 1px solid var(--border-color);
    border-radius: 12px 0 0 12px;
    background: var(--input-bg);
    color: var(--text-primary);
    resize: none;
    font-size: 15px;
    padding: 14px 16px;
  }

  .input-group .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px var(--input-focus);
    background: var(--input-bg);
    color: var(--text-primary);
  }

  .input-group .btn-primary {
    border-radius: 0 12px 12px 0;
    background: var(--primary-color);
    border-color: var(--primary-color);
    padding: 14px 20px;
    font-weight: 600;
  }

  .input-group .btn-primary:hover {
    background: var(--primary-hover);
    border-color: var(--primary-hover);
    transform: none;
  }

  .chat-info {
    margin-top: 8px;
    font-size: 13px;
    color: var(--text-muted);
  }

  .loading .message-bubble {
    animation: pulse 1.5s ease-in-out infinite;
  }

  @keyframes slideIn {
    from {
      transform: translateY(10px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.6;
    }
  }

  /* âœ… ë©”ëª¨ë¦¬ ì¸ì‚¬ì´íŠ¸ ìŠ¤íƒ€ì¼ */
  .memory-insights {
    animation: slideInUp 0.3s ease-out;
  }

  .memory-item {
    padding: 6px 0;
    font-size: 14px;
    color: var(--text-primary);
    border-left: 3px solid var(--primary-color);
    padding-left: 12px;
    margin: 4px 0;
    background: rgba(255, 107, 53, 0.05);
    border-radius: 0 8px 8px 0;
  }

  /* âœ… ì¶”ì²œ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
  .recommendations-panel {
    animation: slideInUp 0.3s ease-out;
  }

  .recommendation-item {
    padding: 10px 14px;
    background: white;
    border: 1px solid rgba(255, 193, 7, 0.3);
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 14px;
    color: var(--text-primary);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .recommendation-item:hover {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
    transform: translateX(4px);
    box-shadow: 0 2px 8px rgba(255, 107, 53, 0.2);
  }

  .recommendation-item:last-child {
    margin-bottom: 0;
  }

  @keyframes slideInUp {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="chat-container">
  <!-- ì±„íŒ… ë©”ì‹œì§€ ì˜ì—­ -->
  <div class="chat-messages" id="chatMessages">
    <div class="welcome-section">
      <img
        src="{% static 'img/mainlogo.png' %}"
        alt="ë…¸ëŠ ë¡œê³ "
        style="
          width: 120px;
          height: 120px;
          border-radius: 16px;
          margin-bottom: 20px;
          object-fit: contain;
          box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
          background: white;
          padding: 10px;
        "
      />
      <h4 class="mt-3">êµí†µì‚¬ê³  ìƒë‹´ ì±—ë´‡ ë…¸ëŠ</h4>
      <p>êµí†µì‚¬ê³  ìƒí™©ì„ ì•Œë ¤ì£¼ì‹œë©´ ê³¼ì‹¤ë¹„ìœ¨ì„ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</p>

      <div class="row mt-4">
        <!-- 1. êµí†µì‚¬ê³  ìƒí™© ë¶„ì„ (accident ì¹´í…Œê³ ë¦¬) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('êµì°¨ë¡œì—ì„œ ë…¹ìƒ‰ì‹ í˜¸ë¡œ ì§ì§„í•˜ëŠ”ë° ë¹¨ê°„ë¶ˆ ë¬´ì‹œí•˜ê³  ì§ì§„í•˜ëŠ” ì°¨ì™€ ì¶©ëŒí–ˆì–´')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">ğŸš— ì‚¬ê³  ìƒí™© ë¶„ì„</h6>
              <p class="card-text small">
                êµì°¨ë¡œ ì§ì§„ ì¤‘ ë¹¨ê°„ë¶ˆ ë¬´ì‹œí•˜ê³  ì§ì§„í•˜ëŠ” ì°¨ì™€ ì¶©ëŒ - ê³¼ì‹¤ë¹„ìœ¨ ë¶„ì„
              </p>
            </div>
          </div>
        </div>
        
        <!-- 2. íŒë¡€ ê²€ìƒ‰ (precedent ì¹´í…Œê³ ë¦¬) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('ëŒ€ë²•ì› 92ë„2077 íŒë¡€ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">âš–ï¸ íŒë¡€ ê²€ìƒ‰</h6>
              <p class="card-text small">
                ëŒ€ë²•ì› 92ë„2077 íŒë¡€ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”
              </p>
            </div>
          </div>
        </div>
        
        <!-- 3. ë„ë¡œêµí†µë²• ì¡°íšŒ (law ì¹´í…Œê³ ë¦¬) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('ë„ë¡œêµí†µë²• ì œ11ì¡°ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">ğŸ“š ë²•ë¥  ì¡°íšŒ</h6>
              <p class="card-text small">
                ë„ë¡œêµí†µë²• ì œ11ì¡°ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”
              </p>
            </div>
          </div>
        </div>
        
        <!-- 4. ìš©ì–´ ì„¤ëª… (term ì¹´í…Œê³ ë¦¬) -->
        <div class="col-md-6 mb-3">
          <div
            class="card example-card"
            onclick="sendExampleMessage('ê³¼ì‹¤ë¹„ìœ¨ì´ ë¬´ì—‡ì¸ê°€ìš”?')"
          >
            <div class="card-body text-start">
              <h6 class="card-title">ğŸ“– ìš©ì–´ ì„¤ëª…</h6>
              <p class="card-text small">
                êµí†µì‚¬ê³  ê´€ë ¨ ë²•ë¥  ìš©ì–´ì˜ ì •í™•í•œ ì˜ë¯¸ ì„¤ëª…
              </p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ë©”ëª¨ë¦¬ ì¸ì‚¬ì´íŠ¸ í‘œì‹œ ì˜ì—­ -->
  <div class="memory-insights" id="memoryInsights" style="display: none;">
    <div class="alert alert-info border-0 bg-gradient" style="background: linear-gradient(45deg, rgba(255, 107, 53, 0.1), rgba(54, 162, 235, 0.1)); border-radius: 12px; margin: 16px 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
      <div class="d-flex align-items-center">
        <i class="bi bi-brain text-primary me-2" style="font-size: 1.2em;"></i>
        <strong>ğŸ’¡ AI ë©”ëª¨ë¦¬ ì¸ì‚¬ì´íŠ¸</strong>
      </div>
      <div id="memoryContent" class="mt-2"></div>
    </div>
  </div>

  <!-- ì‹¤ì‹œê°„ ì¶”ì²œ íŒ¨ë„ (ë¹„í™œì„±í™”) -->
  <!-- 
  <div class="recommendations-panel" id="recommendationsPanel" style="display: none; margin: 16px 24px;">
    <div class="card border-0 shadow-sm" style="border-radius: 12px; background: linear-gradient(45deg, rgba(255, 193, 7, 0.05), rgba(40, 167, 69, 0.05));">
      <div class="card-body">
        <h6 class="card-title text-warning d-flex align-items-center">
          <i class="bi bi-lightbulb-fill me-2"></i> ë§ì¶¤ ì¶”ì²œ
        </h6>
        <div id="recommendationsList"></div>
      </div>
    </div>
  </div>
  -->

  <!-- ë©”ì‹œì§€ ì…ë ¥ ì˜ì—­ -->
  <div class="chat-input-area">
    <div class="input-group">
      <textarea
        class="form-control"
        id="messageInput"
        placeholder="êµí†µì‚¬ê³  ìƒí™©ì„ ìì„¸íˆ ì„¤ëª…í•´ì£¼ì„¸ìš”..."
        rows="2"
      ></textarea>
      <button class="btn btn-primary" id="sendBtn" type="button">
        <i class="bi bi-send"></i> ì „ì†¡
      </button>
    </div>
    <div class="chat-info">
      <i class="bi bi-info-circle"></i>
      ë” ì •í™•í•œ ë¶„ì„ì„ ìœ„í•´ ì‚¬ê³  ìœ„ì¹˜, ì‹ í˜¸ë“± ìƒí™©, ê° ì°¨ëŸ‰ì˜ í–‰ë™ì„ êµ¬ì²´ì ìœ¼ë¡œ
      ì•Œë ¤ì£¼ì„¸ìš”.
    </div>
  </div>
</div>
{% endblock %} {% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
  let currentSessionId = null;

  // ë§ˆí¬ë‹¤ìš´ ì„¤ì •
  marked.setOptions({
    breaks: true,
    gfm: true,
    headerIds: false,
    mangle: false,
  });

  // ë©”ì‹œì§€ ì „ì†¡
  $("#sendBtn").click(sendMessage);
  $("#messageInput").keypress(function (e) {
    if (e.which == 13 && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // ì˜ˆì‹œ ë©”ì‹œì§€ ì „ì†¡
  function sendExampleMessage(message) {
    $("#messageInput").val(message);
    sendMessage();
  }

  // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
  function sendMessage() {
    const message = $("#messageInput").val().trim();
    if (!message) return;

    // í™˜ì˜ í™”ë©´ ìˆ¨ê¸°ê¸°
    $(".welcome-section").hide();

    // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ
    addMessage(message, "user");
    $("#messageInput").val("");

    // ë´‡ ì‘ë‹µ ëŒ€ê¸° í‘œì‹œ
    addMessage("ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...", "bot", true);

    // API í˜¸ì¶œ
    $.ajax({
      url: '{% url "main:send_message" %}',
      method: "POST",
      data: JSON.stringify({
        message: message,
        session_id: currentSessionId,
      }),
      contentType: "application/json",
      timeout: 60000,  // íƒ€ì„ì•„ì›ƒ 60ì´ˆë¡œ ì¦ê°€
      success: function (response) {
      if (response.success) {
      // ëŒ€ê¸° ë©”ì‹œì§€ ì œê±°
      $(".message.bot:last").remove();

      // ë´‡ ì‘ë‹µ í‘œì‹œ (ë§ˆí¬ë‹¤ìš´ ë Œë”ë§)
      addMessage(response.bot_response, "bot");

      // ì„¸ì…˜ ID ì—…ë°ì´íŠ¸
      currentSessionId = response.session_id;

      // âœ… ë©”ëª¨ë¦¬ ì¸ì‚¬ì´íŠ¸ í‘œì‹œ
      if (response.memory_insights) {
        displayMemoryInsights(response.memory_insights);
      }

      // âœ… ì‹¤ì‹œê°„ ì¶”ì²œ ë¡œë“œ (ë¹„í™œì„±í™”)
      // if (currentSessionId) {
      //   loadLiveRecommendations(currentSessionId);
      // }

          // ì‚¬ì´ë“œë°” ì±„íŒ… ê¸°ë¡ ìƒˆë¡œê³ ì¹¨
            if (typeof loadChatHistory === "function") {
              loadChatHistory();
            }
          } else {
            $(".message.bot:last").remove();
            addMessage("ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "bot");
          }
        },
      error: function (xhr, status, error) {
        $(".message.bot:last").remove();
        
        if (status === 'timeout') {
          addMessage("íƒ€ì„ì•„ì›ƒì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”... í˜„ì¬ ì²˜ë¦¬ ì¤‘ì¸ ìš”ì²­ì´ ë§ì•„ ì‘ë‹µì´ ì§€ì—°ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.", "bot");
        } else if (xhr.status === 500) {
          addMessage("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. AI ì‘ë‹µ ìƒì„± ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "bot");
        } else {
          addMessage("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.", "bot");
        }
      },
    });
  }

  // ë©”ì‹œì§€ ì¶”ê°€ í•¨ìˆ˜ (ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ì ìš©)
  function addMessage(content, sender, isLoading = false) {
    const messageClass = sender === "user" ? "user" : "bot";
    const loadingClass = isLoading ? "loading" : "";

    let avatarHtml = "";
    if (sender === "bot") {
      avatarHtml =
        '<img src="{% static "img/chatbot.png" %}" alt="ë…¸ëŠ ì±—ë´‡" class="message-avatar">';
    } else {
      avatarHtml = '<div class="message-avatar">ğŸ‘¤</div>';
    }

    // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ (ë´‡ ë©”ì‹œì§€ì¸ ê²½ìš°ì—ë§Œ)
    let renderedContent;
    if (sender === "bot" && !isLoading) {
      try {
        renderedContent = marked.parse(content);
      } catch (e) {
        console.warn("ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ì‹¤íŒ¨:", e);
        renderedContent = content.replace(/\n/g, "<br>");
      }
    } else {
      renderedContent = isLoading
        ? '<i class="bi bi-three-dots"></i> ' + content
        : content.replace(/\n/g, "<br>");
    }

    const messageHtml = `
        <div class="message ${messageClass} ${loadingClass}">
            ${sender === "bot" ? avatarHtml : ""}
            <div class="message-bubble">
                ${renderedContent}
            </div>
            ${sender === "user" ? avatarHtml : ""}
        </div>
    `;

    $("#chatMessages").append(messageHtml);
    $("#chatMessages").scrollTop($("#chatMessages")[0].scrollHeight);
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ í™œì„± ë„¤ë¹„ê²Œì´ì…˜ ì„¤ì •
  $(document).ready(function () {
    // í˜„ì¬ í˜ì´ì§€ì— ë”°ë¼ ë„¤ë¹„ê²Œì´ì…˜ í™œì„±í™”
    const currentPath = window.location.pathname;
    $(".nav-link").removeClass("active");

    if (currentPath === "/" || currentPath.includes("/main/")) {
      $('a[href="{% url "main:index" %}"]').addClass("active");
    } else if (currentPath.includes("/community/")) {
      $('a[href="{% url "community:list" %}"]').addClass("active");
    }

    // URLì—ì„œ session íŒŒë¼ë¯¸í„° í™•ì¸
    const urlParams = new URLSearchParams(window.location.search);
    const sessionParam = urlParams.get("session");
    if (sessionParam) {
      loadSessionMessages(sessionParam);
    }

    // ìƒˆ ì±„íŒ… ë²„íŠ¼ ê¸°ëŠ¥
    $(".new-chat").click(function (e) {
      e.preventDefault();
      startNewChat();
    });
  });

  // ìƒˆ ì±„íŒ… ì‹œì‘ í•¨ìˆ˜
  function startNewChat() {
    currentSessionId = null;
    $("#chatMessages").html(`
      <div class="welcome-section">
        <img
          src="{% static 'img/mainlogo.png' %}"
          alt="ë…¸ëŠ ë¡œê³ "
          style="
            width: 120px;
            height: 120px;
            border-radius: 16px;
            margin-bottom: 20px;
            object-fit: contain;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.15);
            background: white;
            padding: 10px;
          "
        />
        <h4 class="mt-3">êµí†µì‚¬ê³  ìƒë‹´ ì±—ë´‡ ë…¸ëŠ</h4>
        <p>êµí†µì‚¬ê³  ìƒí™©ì„ ì•Œë ¤ì£¼ì‹œë©´ ê³¼ì‹¤ë¹„ìœ¨ì„ ë¶„ì„í•´ë“œë¦½ë‹ˆë‹¤.</p>
        
        <div class="row mt-4">
          <!-- 1. êµí†µì‚¬ê³  ìƒí™© ë¶„ì„ (accident ì¹´í…Œê³ ë¦¬) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('êµì°¨ë¡œì—ì„œ ë…¹ìƒ‰ì‹ í˜¸ë¡œ ì§ì§„í•˜ëŠ”ë° ë¹¨ê°„ë¶ˆ ë¬´ì‹œí•˜ê³  ì§ì§„í•˜ëŠ” ì°¨ì™€ ì¶©ëŒí–ˆì–´')">
              <div class="card-body text-start">
                <h6 class="card-title">ğŸš— ì‚¬ê³  ìƒí™© ë¶„ì„</h6>
                <p class="card-text small">êµì°¨ë¡œ ì§ì§„ ì¤‘ ë¹¨ê°„ë¶ˆ ë¬´ì‹œí•˜ê³  ì§ì§„í•˜ëŠ” ì°¨ì™€ ì¶©ëŒ - ê³¼ì‹¤ë¹„ìœ¨ ë¶„ì„</p>
              </div>
            </div>
          </div>
          
          <!-- 2. íŒë¡€ ê²€ìƒ‰ (precedent ì¹´í…Œê³ ë¦¬) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('ëŒ€ë²•ì› 92ë„2077 íŒë¡€ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”')">
              <div class="card-body text-start">
                <h6 class="card-title">âš–ï¸ íŒë¡€ ê²€ìƒ‰</h6>
                <p class="card-text small">ëŒ€ë²•ì› 92ë„2077 íŒë¡€ë¥¼ ì°¾ì•„ì£¼ì„¸ìš”</p>
              </div>
            </div>
          </div>
          
          <!-- 3. ë„ë¡œêµí†µë²• ì¡°íšŒ (law ì¹´í…Œê³ ë¦¬) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('ë„ë¡œêµí†µë²• ì œ11ì¡°ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”')">
              <div class="card-body text-start">
                <h6 class="card-title">ğŸ“š ë²•ë¥  ì¡°íšŒ</h6>
                <p class="card-text small">ë„ë¡œêµí†µë²• ì œ11ì¡°ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”</p>
              </div>
            </div>
          </div>
          
          <!-- 4. ìš©ì–´ ì„¤ëª… (term ì¹´í…Œê³ ë¦¬) -->
          <div class="col-md-6 mb-3">
            <div class="card example-card" onclick="sendExampleMessage('ê³¼ì‹¤ë¹„ìœ¨ì´ ë¬´ì—‡ì¸ê°€ìš”?')">
              <div class="card-body text-start">
                <h6 class="card-title">ğŸ“– ìš©ì–´ ì„¤ëª…</h6>
                <p class="card-text small">êµí†µì‚¬ê³  ê´€ë ¨ ë²•ë¥  ìš©ì–´ì˜ ì •í™•í•œ ì˜ë¯¸ ì„¤ëª…</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    `);

    // í™œì„± ì„¸ì…˜ ì œê±°
    $(".session-item").removeClass("active");

    // URLì—ì„œ session íŒŒë¼ë¯¸í„° ì œê±°
    if (window.history.replaceState) {
      window.history.replaceState(null, null, window.location.pathname);
    }
  }

  // ì„¸ì…˜ ë©”ì‹œì§€ ë¡œë“œ í•¨ìˆ˜ (ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ì ìš©)
  function loadSessionMessages(sessionId) {
    $.ajax({
      url: `{% url "main:chat_history" "dummy" %}`.replace("dummy", sessionId),
      method: "GET",
      success: function (response) {
        if (response.success) {
          currentSessionId = sessionId;
          $("#chatMessages").html("");

          response.messages.forEach(function (msg) {
            addMessage(msg.content, msg.sender);
          });

          // í™œì„± ì„¸ì…˜ í‘œì‹œ
          $(".session-item").removeClass("active");
          $(`.session-item[data-session-id="${sessionId}"]`).addClass("active");
        }
      },
      error: function () {
        alert("ì±„íŒ… ê¸°ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      },
    });
  }

  // âœ… ë©”ëª¨ë¦¬ ì¸ì‚¬ì´íŠ¸ í‘œì‹œ í•¨ìˆ˜
  function displayMemoryInsights(insights) {
    const memoryDiv = $("#memoryInsights");
    const contentDiv = $("#memoryContent");
    
    let content = '';
    
    try {
      // ì—°ê´€ ì§ˆë¬¸ ì •ë³´
      const context = insights.conversation_context || {};
      const followup = context.followup_info || {};
      
      if (followup.has_followup && followup.confidence > 0.6) {
        const confidence = Math.round(followup.confidence * 100);
        content += `<div class="memory-item">ğŸ”— ì´ì „ ëŒ€í™”ì™€ ì—°ê´€ëœ ì§ˆë¬¸ìœ¼ë¡œ ì´í•´í–ˆìŠµë‹ˆë‹¤ (ì •í™•ë„: ${confidence}%)</div>`;
      }
      
      // ì‚¬ìš©ì ë ˆë²¨ ì •ë³´
      const userLevel = insights.user_level || {};
      if (userLevel.explanation_level) {
        const levelNames = {
          'beginner': 'ì´ˆë³´ì',
          'intermediate': 'ì¤‘ê¸‰ì', 
          'advanced': 'ì „ë¬¸ê°€'
        };
        const levelName = levelNames[userLevel.explanation_level] || 'ì¼ë°˜';
        const interactionCount = userLevel.interaction_count || 0;
        content += `<div class="memory-item">ğŸ‘¤ í˜„ì¬ ë ˆë²¨: ${levelName} (ìƒí˜¸ì‘ìš© ${interactionCount}íšŒ)</div>`;
      }
      
      // í•™ìŠµ ì§„í–‰ë„
      const learning = insights.learning_progress || {};
      if (Object.keys(learning).length > 0) {
        const avgProgress = Math.round(Object.values(learning).reduce((a, b) => a + b, 0) / Object.keys(learning).length * 100);
        content += `<div class="memory-item">ğŸ“š ì „ì²´ í•™ìŠµ ì§„í–‰ë„: ${avgProgress}%</div>`;
      }
      
      // ìˆ™ë ¨ ë¶„ì•¼
      const usage = insights.usage_analytics || {};
      if (usage.category_usage && Object.keys(usage.category_usage).length > 0) {
        const topCategories = Object.entries(usage.category_usage)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 2)
          .map(([cat, count]) => {
            const categoryNames = {
              'accident': 'ì‚¬ê³ ë¶„ì„',
              'precedent': 'íŒë¡€ê²€ìƒ‰',
              'law': 'ë²•ë¥ ì¡°íšŒ',
              'term': 'ìš©ì–´ì„¤ëª…'
            };
            return categoryNames[cat] || cat;
          });
        
        if (topCategories.length > 0) {
          content += `<div class="memory-item">â­ ì£¼ìš” í™œìš© ë¶„ì•¼: ${topCategories.join(', ')}</div>`;
        }
      }
      
      if (content) {
        contentDiv.html(content);
        memoryDiv.fadeIn(300);
        
        // 6ì´ˆ í›„ ìë™ ìˆ¨ê¹€
        setTimeout(() => {
          memoryDiv.fadeOut(300);
        }, 6000);
      }
    } catch (error) {
      console.warn('ë©”ëª¨ë¦¬ ì¸ì‚¬ì´íŠ¸ í‘œì‹œ ì˜¤ë¥˜:', error);
    }
  }

  // âœ… ì‹¤ì‹œê°„ ì¶”ì²œ ë¡œë“œ í•¨ìˆ˜
  function loadLiveRecommendations(sessionId) {
    if (!sessionId) return;
    
    $.ajax({
      url: `{% url "main:live_recommendations" "dummy" %}`.replace("dummy", sessionId),
      method: "GET",
      success: function(response) {
        if (response.success && response.recommendations && response.recommendations.length > 0) {
          displayRecommendations(response.recommendations);
        }
      },
      error: function(xhr, status, error) {
        console.log('ì¶”ì²œ ë¡œë“œ ì‹¤íŒ¨:', error);
      }
    });
  }

  // âœ… ì¶”ì²œ í‘œì‹œ í•¨ìˆ˜
  function displayRecommendations(recommendations) {
    const panelDiv = $("#recommendationsPanel");
    const listDiv = $("#recommendationsList");
    
    if (recommendations && recommendations.length > 0) {
      const items = recommendations.map(rec => {
        const escapedRec = rec.replace(/'/g, "\\'")
                            .replace(/"/g, '&quot;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');
        return `<div class="recommendation-item" onclick="sendExampleMessage('${escapedRec}')">
                  <i class="bi bi-lightbulb text-warning"></i>
                  ${rec}
                </div>`;
      }).join('');
      
      listDiv.html(items);
      panelDiv.slideDown(300);
      
      // 12ì´ˆ í›„ ìë™ ìˆ¨ê¹€
      setTimeout(() => {
        panelDiv.slideUp(300);
      }, 12000);
    }
  }

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (base.htmlì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡)
  window.loadSessionMessages = loadSessionMessages;
  window.displayMemoryInsights = displayMemoryInsights;
  window.loadLiveRecommendations = loadLiveRecommendations;
</script>
{% endblock %}
